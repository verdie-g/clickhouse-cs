name: Benchmark Comparison

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to benchmark (leave empty if running on PR branch)'
        required: false
        type: string

jobs:
  benchmark-compare:
    name: Compare PR vs Main
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    services:
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        ports:
          - 8123:8123
        env:
          CLICKHOUSE_DB: test
          CLICKHOUSE_USER: test
          CLICKHOUSE_PASSWORD: test1234
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: '1'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.pr_number && format('refs/pull/{0}/head', inputs.pr_number) || '' }}
          path: pr

      - name: Checkout main branch
        uses: actions/checkout@v6
        with:
          ref: main
          path: main

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.x

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Get PR number
        id: pr
        run: |
          PR_NUM="${{ inputs.pr_number }}"
          if [ -z "$PR_NUM" ]; then
            cd pr
            PR_NUM=$(gh pr view --json number -q .number 2>/dev/null || echo "local")
            cd ..
          fi
          echo "number=$PR_NUM" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build main package
        run: |
          mkdir -p pr/.nupkg
          dotnet build main/ClickHouse.Driver/ClickHouse.Driver.csproj \
            --configuration Release \
            /p:Version=0.0.0-main
          cp main/ClickHouse.Driver/bin/Release/*.nupkg pr/.nupkg/

      - name: Build PR package
        run: |
          dotnet build pr/ClickHouse.Driver/ClickHouse.Driver.csproj \
            --configuration Release \
            /p:Version=0.0.0-pr.${{ steps.pr.outputs.number }}
          cp pr/ClickHouse.Driver/bin/Release/*.nupkg pr/.nupkg/

      - name: Run comparison benchmarks
        working-directory: pr
        run: |
          dotnet run \
            --project ClickHouse.Driver.Benchmark/ClickHouse.Driver.Benchmark.csproj \
            --framework net10.0 \
            --configuration Release \
            -p:BenchmarkComparisonMode=true \
            -- --join --filter "*" --artifacts .
        env:
          CLICKHOUSE_CONNECTION: Host=localhost;Port=8123;Username=test;Password=test1234
          BASELINE_VERSION: 0.0.0-main
          PR_VERSION: 0.0.0-pr.${{ steps.pr.outputs.number }}
          NUGET_SOURCE: ${{ github.workspace }}/pr/.nupkg

      - name: Post results to PR
        if: steps.pr.outputs.number != 'local'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const resultsDir = 'pr/results';
            const files = fs.readdirSync(resultsDir)
              .filter(f => f.endsWith('-report-github.md'))
              .map(f => path.join(resultsDir, f));

            const prNumber = parseInt('${{ steps.pr.outputs.number }}');

            let body = '## Benchmark Comparison\n\n';
            body += `**Baseline:** main branch\n`;
            body += `**PR:** #${prNumber}\n\n`;

            for (const file of files) {
              const content = fs.readFileSync(file, 'utf8');
              body += content + '\n\n';
            }

            body += '\n\n<sub>Generated by benchmark workflow</sub>';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Benchmark Comparison')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      - name: Post results to summary
        run: cat pr/results/*-report-github.md >> $GITHUB_STEP_SUMMARY
